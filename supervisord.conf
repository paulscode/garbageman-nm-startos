# ==============================================================================
# Garbageman Nodes Manager - Supervisord Configuration
# ==============================================================================
# Manages three services within the StartOS container:
# 1. supervisor - Multi-daemon manager (manages Bitcoin node instances)
# 2. api        - Fastify REST API server (backend)
# 3. ui         - Next.js web interface (frontend)
#
# All services:
# - Run as root (required for StartOS volume access)
# - Auto-restart on failure (up to 3 retries)
# - Log to stdout/stderr for StartOS log collection
# - Receive environment variables from docker_entrypoint.sh
#
# Environment variables are interpolated using %(ENV_VAR_NAME)s syntax
# ==============================================================================

[supervisord]
nodaemon=true
logfile=/tmp/supervisord.log
pidfile=/tmp/supervisord.pid
loglevel=info

# ==============================================================================
# Multi-Daemon Supervisor
# ==============================================================================
# Manages Bitcoin daemon instances (Garbageman/Knots)
# Handles instance lifecycle: start, stop, monitor, cleanup
# Exposes management API on SUPERVISOR_PORT (default 9000)

[program:supervisor]
command=node /app/supervisor/dist/supervisor.stub.js
directory=/app/supervisor
autostart=true
autorestart=true
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    SUPERVISOR_PORT="%(ENV_SUPERVISOR_PORT)s",
    DATA_DIR="%(ENV_DATA_DIR)s",
    ARTIFACTS_DIR="%(ENV_ARTIFACTS_DIR)s",
    ENVFILES_DIR="%(ENV_ENVFILES_DIR)s"

# ==============================================================================
# API Server (Fastify)
# ==============================================================================
# REST API backend for web UI
# Handles configuration, instance management, peer discovery
# Communicates with supervisor for daemon control
# Exposes API on PORT (default 8080)

[program:api]
command=node /app/api/dist/server.js
directory=/app/api
autostart=true
autorestart=true
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    PORT="%(ENV_API_PORT)s",
    HOST="0.0.0.0",
    ENVFILES_DIR="%(ENV_ENVFILES_DIR)s",
    SUPERVISOR_URL="http://localhost:%(ENV_SUPERVISOR_PORT)s",
    LOG_LEVEL="%(ENV_LOG_LEVEL)s",
    NODE_ENV="production",
    TOR_PROXY_HOST="%(ENV_TOR_PROXY_HOST)s",
    TOR_PROXY_PORT="%(ENV_TOR_PROXY_PORT)s"

# ==============================================================================
# Web UI (Next.js)
# ==============================================================================
# Frontend dashboard for managing Bitcoin nodes
# Server-side rendered React application
# Communicates with API server for all operations
# Exposes UI on PORT (default 5173)
# Accessible via Tor hidden service and optional LAN

[program:ui]
command=node /app/ui/server.js
directory=/app/ui
autostart=true
autorestart=true
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    PORT="%(ENV_UI_PORT)s",
    HOSTNAME="0.0.0.0",
    WEBUI_PASSWORD="%(ENV_WEBUI_PASSWORD)s",
    WRAPPER_UI_PASSWORD="%(ENV_WRAPPER_UI_PASSWORD)s",
    API_BASE_URL="http://localhost:%(ENV_API_PORT)s"
